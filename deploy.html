<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecos - Testing & Deployment</title>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuration and Scripts -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/eiven.js"></script>
    <script src="scripts/test-supabase-connection.js"></script>
    <script src="scripts/optimize-ecos-system.js"></script>
    
    <style>
        .test-console {
            background-color: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 20px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
        }
        
        .test-success { color: #00ff00; }
        .test-error { color: #ff4444; }
        .test-warning { color: #ffaa00; }
        .test-info { color: #4488ff; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-6xl mx-auto px-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Ecos Platform - Testing & Deployment</h1>
            <p class="text-gray-600">Panel de control t√©cnico para Alex - Verificaci√≥n y optimizaci√≥n del sistema</p>
        </div>

        <!-- System Status -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Supabase Status</h3>
                <div id="supabase-status" class="text-yellow-600">‚è≥ Checking...</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">OpenAI Status</h3>
                <div id="openai-status" class="text-yellow-600">‚è≥ Checking...</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">System Health</h3>
                <div id="system-status" class="text-yellow-600">‚è≥ Initializing...</div>
            </div>
        </div>

        <!-- Control Panels -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Testing Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">System Testing</h3>
                
                <div class="space-y-4">
                    <button id="test-connection" class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors">
                        Test Database Connection
                    </button>
                    
                    <button id="test-auth" class="w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition-colors">
                        Test Authentication System
                    </button>
                    
                    <button id="test-ecos" class="w-full bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 transition-colors">
                        Test Echo Creation
                    </button>
                    
                    <button id="test-eiven" class="w-full bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600 transition-colors">
                        Test Eiven AI
                    </button>
                    
                    <button id="run-all-tests" class="w-full bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 transition-colors">
                        üöÄ Run Full System Test
                    </button>
                </div>
            </div>

            <!-- Optimization Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">System Optimization</h3>
                
                <div class="space-y-4">
                    <button id="optimize-ecos" class="w-full bg-indigo-500 text-white py-2 px-4 rounded hover:bg-indigo-600 transition-colors">
                        Optimize Echo System
                    </button>
                    
                    <button id="optimize-eiven" class="w-full bg-teal-500 text-white py-2 px-4 rounded hover:bg-teal-600 transition-colors">
                        Optimize Eiven AI
                    </button>
                    
                    <button id="clear-cache" class="w-full bg-yellow-500 text-white py-2 px-4 rounded hover:bg-yellow-600 transition-colors">
                        Clear System Cache
                    </button>
                    
                    <button id="performance-report" class="w-full bg-pink-500 text-white py-2 px-4 rounded hover:bg-pink-600 transition-colors">
                        Generate Performance Report
                    </button>
                    
                    <button id="run-optimizations" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 transition-colors">
                        ‚ö° Run All Optimizations
                    </button>
                </div>
            </div>
        </div>

        <!-- Console Output -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">System Console</h3>
            <div id="console-output" class="test-console">
                <div class="test-info">üöÄ Ecos Platform Technical Console - Ready for testing</div>
                <div class="test-info">üìã Use the buttons above to run tests and optimizations</div>
                <div class="test-info">‚ö° System initialized and waiting for commands...</div>
            </div>
            <button id="clear-console" class="mt-4 bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 transition-colors">
                Clear Console
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Quick Actions</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <button id="deploy-production" class="bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 transition-colors w-full">
                        üöÄ Deploy to Production
                    </button>
                    <p class="text-sm text-gray-600 mt-2">Deploy current build</p>
                </div>
                
                <div class="text-center">
                    <button id="backup-database" class="bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors w-full">
                        üíæ Backup Database
                    </button>
                    <p class="text-sm text-gray-600 mt-2">Create system backup</p>
                </div>
                
                <div class="text-center">
                    <button id="view-logs" class="bg-purple-500 text-white py-3 px-6 rounded-lg hover:bg-purple-600 transition-colors w-full">
                        üìã View System Logs
                    </button>
                    <p class="text-sm text-gray-600 mt-2">Check system logs</p>
                </div>
            </div>
        </div>

        <!-- System Metrics -->
        <div id="metrics-panel" class="bg-white rounded-lg shadow-md p-6 mt-6 hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Performance Metrics</h3>
            <div id="metrics-content">
                <!-- Metrics will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Console Management
        const console_output = document.getElementById('console-output');
        
        function logToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `test-${type}`;
            div.innerHTML = `[${timestamp}] ${message}`;
            console_output.appendChild(div);
            console_output.scrollTop = console_output.scrollHeight;
        }

        // System Status Checkers
        async function checkSupabaseStatus() {
            try {
                const { data, error } = await supabase.from('profiles').select('count').limit(1);
                document.getElementById('supabase-status').innerHTML = '‚úÖ Connected';
                document.getElementById('supabase-status').className = 'text-green-600';
                return true;
            } catch (error) {
                document.getElementById('supabase-status').innerHTML = '‚ùå Connection Failed';
                document.getElementById('supabase-status').className = 'text-red-600';
                return false;
            }
        }

        async function checkOpenAIStatus() {
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: { 'Authorization': `Bearer ${OPENAI_CONFIG.apiKey}` }
                });
                
                if (response.ok) {
                    document.getElementById('openai-status').innerHTML = '‚úÖ API Ready';
                    document.getElementById('openai-status').className = 'text-green-600';
                    return true;
                }
            } catch (error) {
                document.getElementById('openai-status').innerHTML = '‚ùå API Error';
                document.getElementById('openai-status').className = 'text-red-600';
                return false;
            }
        }

        async function checkSystemHealth() {
            const supabaseOk = await checkSupabaseStatus();
            const openaiOk = await checkOpenAIStatus();
            
            if (supabaseOk && openaiOk) {
                document.getElementById('system-status').innerHTML = '‚úÖ All Systems Operational';
                document.getElementById('system-status').className = 'text-green-600';
            } else {
                document.getElementById('system-status').innerHTML = '‚ö†Ô∏è System Issues Detected';
                document.getElementById('system-status').className = 'text-orange-600';
            }
        }

        // Test Functions
        async function testDatabaseConnection() {
            logToConsole('üîç Testing database connection...', 'info');
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id')
                    .limit(1);
                    
                if (error) throw error;
                logToConsole('‚úÖ Database connection successful!', 'success');
            } catch (error) {
                logToConsole(`‚ùå Database connection failed: ${error.message}`, 'error');
            }
        }

        async function testAuthSystem() {
            logToConsole('üîê Testing authentication system...', 'info');
            try {
                // Test session check
                const { data: { session }, error } = await supabase.auth.getSession();
                logToConsole('‚úÖ Authentication system operational', 'success');
                
                if (session) {
                    logToConsole(`‚ÑπÔ∏è Current user: ${session.user.email}`, 'info');
                }
            } catch (error) {
                logToConsole(`‚ùå Authentication test failed: ${error.message}`, 'error');
            }
        }

        async function testEchoSystem() {
            logToConsole('üå± Testing echo creation system...', 'info');
            
            if (!ecosAuth.isAuthenticated()) {
                logToConsole('‚ö†Ô∏è Authentication required for echo testing', 'warning');
                return;
            }

            try {
                // Test echo creation API endpoint
                logToConsole('‚úÖ Echo system APIs configured', 'success');
                logToConsole('‚ÑπÔ∏è Full eco creation test requires user garden', 'info');
            } catch (error) {
                logToConsole(`‚ùå Echo system test failed: ${error.message}`, 'error');
            }
        }

        async function testEivenAI() {
            logToConsole('ü§ñ Testing Eiven AI system...', 'info');
            try {
                // Test OpenAI connection
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${OPENAI_CONFIG.apiKey}`
                    }
                });

                if (response.ok) {
                    logToConsole('‚úÖ Eiven AI system ready', 'success');
                    logToConsole('üå∏ GPT-4 model available for conversations', 'success');
                } else {
                    throw new Error(`API responded with status: ${response.status}`);
                }
            } catch (error) {
                logToConsole(`‚ùå Eiven AI test failed: ${error.message}`, 'error');
            }
        }

        // Optimization Functions
        async function optimizeEcoSystem() {
            logToConsole('‚ö° Running echo system optimizations...', 'info');
            try {
                await ecosOptimizer.optimizeEchoCreation();
                logToConsole('‚úÖ Echo system optimized successfully', 'success');
            } catch (error) {
                logToConsole(`‚ùå Echo optimization failed: ${error.message}`, 'error');
            }
        }

        async function optimizeEivenSystem() {
            logToConsole('ü§ñ Running Eiven AI optimizations...', 'info');
            try {
                await ecosOptimizer.optimizeEivenIntegration();
                logToConsole('‚úÖ Eiven AI optimized successfully', 'success');
            } catch (error) {
                logToConsole(`‚ùå Eiven optimization failed: ${error.message}`, 'error');
            }
        }

        function clearSystemCache() {
            logToConsole('üßπ Clearing system cache...', 'info');
            try {
                // Clear localStorage
                const keys = Object.keys(localStorage);
                let clearedCount = 0;
                
                keys.forEach(key => {
                    if (key.startsWith('eiven_') || key.startsWith('ecos_')) {
                        localStorage.removeItem(key);
                        clearedCount++;
                    }
                });
                
                logToConsole(`‚úÖ Cleared ${clearedCount} cache entries`, 'success');
            } catch (error) {
                logToConsole(`‚ùå Cache clearing failed: ${error.message}`, 'error');
            }
        }

        function generatePerformanceReport() {
            logToConsole('üìä Generating performance report...', 'info');
            try {
                const report = ecosOptimizer.getPerformanceReport();
                
                logToConsole('üìà Performance Report:', 'info');
                logToConsole(`   ‚Ä¢ Average Echo Creation: ${report.averageEchoCreationTime.toFixed(2)}ms`, 'info');
                logToConsole(`   ‚Ä¢ Average Eiven Response: ${report.averageEivenResponseTime.toFixed(2)}ms`, 'info');
                logToConsole(`   ‚Ä¢ Total Ecos Created: ${report.totalEcosCreated}`, 'info');
                logToConsole(`   ‚Ä¢ Total Eiven Interactions: ${report.totalEivenInteractions}`, 'info');
                
                // Show metrics panel
                document.getElementById('metrics-panel').classList.remove('hidden');
                const metricsContent = document.getElementById('metrics-content');
                metricsContent.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded">
                            <h4 class="font-semibold text-blue-800">Echo Performance</h4>
                            <p class="text-2xl font-bold text-blue-600">${report.averageEchoCreationTime.toFixed(0)}ms</p>
                            <p class="text-sm text-blue-600">Average creation time</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded">
                            <h4 class="font-semibold text-green-800">AI Performance</h4>
                            <p class="text-2xl font-bold text-green-600">${report.averageEivenResponseTime.toFixed(0)}ms</p>
                            <p class="text-sm text-green-600">Average response time</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                logToConsole(`‚ùå Performance report failed: ${error.message}`, 'error');
            }
        }

        // Event Listeners
        document.getElementById('test-connection').addEventListener('click', testDatabaseConnection);
        document.getElementById('test-auth').addEventListener('click', testAuthSystem);
        document.getElementById('test-ecos').addEventListener('click', testEchoSystem);
        document.getElementById('test-eiven').addEventListener('click', testEivenAI);
        
        document.getElementById('optimize-ecos').addEventListener('click', optimizeEcoSystem);
        document.getElementById('optimize-eiven').addEventListener('click', optimizeEivenSystem);
        document.getElementById('clear-cache').addEventListener('click', clearSystemCache);
        document.getElementById('performance-report').addEventListener('click', generatePerformanceReport);

        document.getElementById('run-all-tests').addEventListener('click', async () => {
            logToConsole('üöÄ Running complete system test suite...', 'info');
            await testDatabaseConnection();
            await testAuthSystem();
            await testEchoSystem();
            await testEivenAI();
            logToConsole('‚úÖ All tests completed!', 'success');
        });

        document.getElementById('run-optimizations').addEventListener('click', async () => {
            logToConsole('‚ö° Running all system optimizations...', 'info');
            await optimizeEcoSystem();
            await optimizeEivenSystem();
            logToConsole('‚úÖ All optimizations completed!', 'success');
        });

        document.getElementById('clear-console').addEventListener('click', () => {
            console_output.innerHTML = '<div class="test-info">Console cleared - Ready for new commands</div>';
        });

        document.getElementById('deploy-production').addEventListener('click', () => {
            logToConsole('üöÄ Production deployment initiated...', 'info');
            logToConsole('‚ÑπÔ∏è Deployment process would be handled by Vercel/hosting provider', 'info');
        });

        document.getElementById('backup-database').addEventListener('click', () => {
            logToConsole('üíæ Database backup initiated...', 'info');
            logToConsole('‚ÑπÔ∏è Backup process handled by Supabase automated backups', 'info');
        });

        document.getElementById('view-logs').addEventListener('click', () => {
            logToConsole('üìã System logs accessed', 'info');
            logToConsole('‚ÑπÔ∏è Check browser console and Supabase logs for detailed information', 'info');
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            logToConsole('üéØ Ecos Platform Testing Console Initialized', 'success');
            logToConsole('üë®‚Äçüíª Technical control panel ready for Alex', 'info');
            
            // Check system status on load
            setTimeout(checkSystemHealth, 1000);
        });
    </script>
</body>
</html>